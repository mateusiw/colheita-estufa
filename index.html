<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resumo de Colheita SPG SEDE - 2026</title>
    
    <!-- Configurações PWA -->
    <link rel="icon" type="image/png" href="https://i.imgur.com/wEozr34.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/wEozr34.png">
    <link rel="manifest" href='data:application/manifest+json,{"name":"SPG SEDE 2026","short_name":"SPG SEDE","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#ffffff","icons":[{"src":"https://i.imgur.com/wEozr34.png","sizes":"192x192","type":"image/png"},{"src":"https://i.imgur.com/wEozr34.png","sizes":"512x512","type":"image/png"}]}'>
    
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SPG SEDE">
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select, textarea { line-height: 1.5; }
        .animate-fade-in-down { animation: fadeInDown 0.3s ease-out forwards; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen pb-20 select-none">

    <!-- Navbar -->
    <div class="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm sticky top-0 z-40">
        <div class="flex items-center gap-3">
            <img src="https://i.imgur.com/wEozr34.png" alt="Logo SPG" class="w-8 h-8 rounded-lg shadow-sm border border-slate-100">
            <div>
                <h1 class="text-sm font-bold text-slate-800 leading-tight">SPG SEDE</h1>
                <p class="text-[10px] text-slate-500 font-medium">Resumo de Colheita SPG SEDE</p>
            </div>
        </div>
        <div class="flex gap-2">
            <!-- Botão Imagem (Renomeado e Atualizado) -->
            <button type="button" onclick="downloadImage()" class="flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-xs font-bold shadow-lg shadow-emerald-600/20 transition-all active:scale-95 active:bg-emerald-800">
                <i data-lucide="share-2" class="w-4 h-4"></i>
                <span>Enviar Imagem para o WhatsApp</span>
            </button>

            <!-- Botão PDF (Oculto) -->
            <button type="button" onclick="downloadPDF()" class="hidden items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-xs font-bold shadow-lg shadow-emerald-600/20 transition-all active:scale-95 active:bg-emerald-800">
                <i data-lucide="file-down" class="w-4 h-4"></i>
                <span>Baixar PDF</span>
            </button>
        </div>
    </div>

    <div class="container mx-auto p-4 flex flex-col lg:flex-row gap-8 mt-4">
        
        <!-- COLUNA DA ESQUERDA: CONTROLES -->
        <div class="w-full lg:w-1/3 space-y-4">
            
            <!-- 2. ADICIONAR BLOCOS -->
            <div id="formContainer" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 transition-colors duration-300">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="formTitle" class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="file-plus" class="text-emerald-600"></i> Adicionar Lote de Produção
                    </h2>
                    <button type="button" onclick="clearBlockForm()" class="text-xs font-semibold text-slate-400 hover:text-red-500 transition-colors flex items-center gap-1">
                        <i data-lucide="eraser" class="w-3 h-3"></i> Limpar/Cancelar
                    </button>
                </div>
                
                <form id="harvestForm" onsubmit="addItem(event)" class="space-y-4">
                    
                    <!-- CAMPO BLOCO -->
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">SETOR</label>
                        <select id="talhao" required class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm bg-white">
                            <option value="">Selecione...</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>

                    <!-- LINHA DE VARIEDADE E COMERCIAL -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Cultura</label>
                            <select id="variety" onchange="updateCommercialInput()" required class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm bg-white">
                                <option value="">Selecione...</option>
                                <option value="Pepino">Pepino</option>
                            </select>
                        </div>
                        <div id="commercialVarietyWrapper">
                            <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Var. Comercial</label>
                            <!-- Será preenchido pelo JS -->
                        </div>
                    </div>

                    <!-- INFORMAÇÕES ADICIONAIS -->
                    <div class="border-t border-slate-100 my-2 pt-2">
                        <label class="text-xs font-bold text-slate-400 block mb-3">Informações Adicionais</label>
                        
                        <!-- REORGANIZADO: Unidades (hoje) e Peso (kg) na mesma linha -->
                        <div class="grid grid-cols-2 gap-2 mb-2">
                             <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block">Unidades (hoje)</label>
                                <input type="text" id="dailyUnits" oninput="formatNumberInput(this); calcAverageWeight()" placeholder="Ex: 5.000" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block">Peso (kg)</label>
                                <!-- Modificado para formatDecimalInput -->
                                <input type="text" id="weight" oninput="formatDecimalInput(this); calcAverageWeight()" placeholder="Ex: 1,500" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                            </div>
                        </div>

                        <!-- PESO MÉDIO E TAMANHO MÉDIO -->
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block">Peso Médio (g/unid.)</label>
                                <input type="text" id="averageWeight" readonly class="w-full p-2 border border-slate-200 bg-slate-50 rounded-lg text-sm text-slate-600 font-bold focus:outline-none" placeholder="Auto">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block">Tam. Médio (cm)</label>
                                <input type="text" id="cucumberSize" placeholder="Ex: 22" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-emerald-500 outline-none">
                            </div>
                        </div>

                        <!-- CLASSIFICAÇÃO E Nª COLHEITA -->
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block">Classificação</label>
                                <select id="cucumberType" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-emerald-500 outline-none">
                                    <option value="Padrão">Padrão</option>
                                    <option value="Curvado">Curvado</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block">Qtd. Colheitas</label>
                                <select id="harvestNumber" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-emerald-500 outline-none">
                                    <option value="1">1 Colheita</option>
                                    <option value="2">2 Colheitas</option>
                                    <option value="3">3 Colheitas</option>
                                    <option value="4">4 Colheitas</option>
                                    <option value="5">5 Colheitas</option>
                                </select>
                            </div>
                        </div>

                        <!-- DESCARTE -->
                        <div class="mb-2">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="isDiscard" onchange="toggleDiscardFields()" class="sr-only peer">
                                <div class="relative w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
                                <span class="ms-2 text-[10px] font-bold text-slate-600 uppercase">É Descarte?</span>
                            </label>
                            
                            <!-- CAMPOS EXTRAS DE DESCARTE (Ocultos por padrão) -->
                            <div id="discardFields" class="hidden mt-3 p-3 bg-red-50 border border-red-100 rounded-xl animate-fade-in-down">
                                <label class="text-[10px] font-bold text-red-500 uppercase mb-2 block flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> Detalhes do Descarte</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Início</label>
                                        <input type="time" id="discardStart" onchange="calcDiscardDuration()" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-red-200 outline-none">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Fim</label>
                                        <input type="time" id="discardEnd" onchange="calcDiscardDuration()" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-red-200 outline-none">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Duração</label>
                                        <input type="text" id="discardDuration" placeholder="00:00" class="w-full p-2 border border-slate-300 bg-slate-100 rounded-lg text-sm font-bold text-slate-600" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl transition-all flex justify-center items-center gap-2 mt-4 active:scale-95">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i> <span>Adicionar ao Relatório</span>
                    </button>
                </form>
            </div>

            <!-- Lista de Itens -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-slate-700">Itens Gerados</h3>
                    <button id="clearAllBtn" onclick="clearAll()" class="text-xs text-red-500 hover:text-red-700 font-bold underline transition-all">Limpar Tudo</button>
                </div>
                <ul id="itemsList" class="space-y-2 text-sm text-slate-600">
                    <!-- JS -->
                </ul>
            </div>
        </div>

        <!-- PREVIEW -->
        <div class="w-full lg:w-2/3 flex flex-col bg-slate-200/50 p-4 rounded-3xl border border-slate-300/50 min-h-[calc(100vh-6rem)]">
            <div id="report-card" class="w-full flex-1 flex flex-col bg-white rounded-none shadow-2xl overflow-hidden border border-slate-100 relative">
                
                <!-- Cabeçalho -->
                <div class="bg-gradient-to-br from-emerald-600 to-emerald-800 p-6 text-white relative overflow-hidden flex flex-col justify-start shrink-0 gap-3">
                    <img src="https://i.imgur.com/wEozr34.png" alt="Logo SPG" class="absolute top-4 right-4 w-20 h-20 z-0">
                    <div class="relative z-10 w-full pr-24"> 
                        <h2 id="reportTitle" class="text-base font-bold leading-snug tracking-normal"></h2>
                        <div class="mt-3 pt-3 border-t border-white/20">
                             <span id="headerDateTime" class="text-xs font-medium text-emerald-50 block opacity-90 tracking-wide"></span>
                        </div>
                    </div>
                </div>

                <!-- NEW SUMMARY STATS LOCATION (TOP) -->
                <div id="summaryStats" class="bg-white px-4 pt-4 shrink-0">
                    <!-- Totals will be injected here -->
                </div>

                <!-- Conteúdo -->
                <div id="reportContent" class="divide-y divide-slate-50 flex-1 overflow-y-auto">
                    <div class="p-8 text-center text-slate-400 text-xs italic leading-relaxed h-full flex items-center justify-center">Adicione blocos no formulário ao lado.</div>
                </div>

                <!-- Rodapé Marca -->
                <div class="bg-slate-100 p-3 text-center border-t border-slate-200 shrink-0">
                    <div class="flex justify-center items-center gap-2 text-[10px] text-slate-400 font-medium uppercase tracking-widest leading-relaxed">
                        SPG SEDE • Dados Oficiais
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- MODAL GENÉRICO DE MENSAGEM -->
    <div id="messageModal" class="fixed inset-0 bg-black/50 z-50 hidden flex justify-center items-center backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm transform transition-all scale-100 text-center">
            <div id="msgIconContainer" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4">
                <!-- Icon injetado via JS -->
            </div>
            <h3 id="msgTitle" class="text-lg font-bold text-slate-800"></h3>
            <p id="msgText" class="text-sm text-slate-500 mt-2 mb-4"></p>
            <button onclick="hideMessageModal()" class="w-full px-4 py-2 bg-slate-800 hover:bg-slate-900 text-white font-bold rounded-lg text-sm transition-colors">OK</button>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        console.log("Aplicação 'Resumo de Colheita SPG Oásis' reiniciada.");

        let harvestData = JSON.parse(localStorage.getItem('spg_harvestData')) || [];
        let editingIndex = -1;
        let clearConfirmTimer;

        lucide.createIcons();
        updateDynamicTitle(); 
        
        // --- INICIALIZAÇÃO CORRETA DO FORMULÁRIO ---
        setTimeout(() => {
            clearBlockForm();
            sortHarvestData();
            renderList(); 
            renderReport(); 
        }, 100);

        // --- FUNÇÕES DE DATA E HORA ---
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function updateDynamicTitle() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const weekNumber = getWeekNumber(now);
            const daysOfWeek = ["Domingo", "Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];
            const dayOfWeek = daysOfWeek[now.getDay()];

            let greeting = hours < 12 ? "Bom dia, Pessoal!" : (hours < 18 ? "Boa tarde, Pessoal!" : "Boa noite, Pessoal!");
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const timeString = `${String(hours).padStart(2, '0')}:${minutes}${ampm}`; 

            // VERIFICAÇÃO SE É DESCARTE PARA O TÍTULO
            const hasDiscard = harvestData.length > 0 && harvestData.some(item => item.isDiscard);
            const reportType = hasDiscard ? "Descarte" : "Resumo da Colheita";

            const titleEl = document.getElementById('reportTitle');
            if (titleEl) titleEl.innerHTML = `${greeting}<br>${reportType} de ${dayOfWeek}`;
            
            const dateEl = document.getElementById('headerDateTime');
            if (dateEl) dateEl.innerText = `Data: ${day}/${month}/${year} - ${timeString} - Semana ${weekNumber}`;
        }

        // --- FORMATAÇÃO E CÁLCULOS ---
        function formatNumberInput(input) {
            let value = input.value.replace(/\D/g, '');
            input.value = value ? value.replace(/\B(?=(\d{3})+(?!\d))/g, ".") : "";
        }

        // Nova função para permitir decimais no peso
        function formatDecimalInput(input) {
            let value = input.value.replace(/[^0-9,]/g, ''); // Permite apenas números e vírgula
            const parts = value.split(',');
            if (parts.length > 2) { 
                value = parts[0] + ',' + parts.slice(1).join(''); // Mantém apenas a primeira vírgula
            }
            input.value = value;
        }

        // FUNÇÃO DE FORMATAÇÃO INTELIGENTE CENTRALIZADA
        function formatSmart(value) {
            if (value === 0 || value === '0') return "0";
            
            // Garante que é número
            const num = typeof value === 'string' ? parsePTBRNumber(value) : value;
            if (isNaN(num)) return value;

            if (num >= 1) {
                // >= 1kg: Remove zeros extras (ex: 18,300 -> 18,3)
                return num.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 3});
            } else {
                // < 1kg: Formata SEMPRE com 3 casas para manter precisão (ex: 0,160)
                return num.toLocaleString('pt-BR', {minimumFractionDigits: 3, maximumFractionDigits: 3});
            }
        }

        function calcAverageWeight() {
            const weightVal = document.getElementById('weight').value;
            const unitsVal = document.getElementById('dailyUnits').value;
            const avgField = document.getElementById('averageWeight');

            const weight = parsePTBRNumber(weightVal);
            const units = parsePTBRNumber(unitsVal);

            if (weight > 0 && units > 0) {
                // Cálculo (peso / unidades)
                const avg = weight / units;
                // Aplica a formatação inteligente no campo input também
                avgField.value = formatSmart(avg) + ' g'; 
            } else {
                avgField.value = '';
            }
        }

        function parsePTBRNumber(val) {
            if (!val) return 0;
            // Converte string PT-BR (1.000,00) para float JS (1000.00)
            if (typeof val === 'number') return val;
            return parseFloat(val.toString().replace(/\./g, '').replace(',', '.')) || 0;
        }

        // --- STORAGE E ORDENAÇÃO ---
        function saveData() { localStorage.setItem('spg_harvestData', JSON.stringify(harvestData)); }
        
        // --- NOVA FUNÇÃO DE ORDENAÇÃO ---
        function sortHarvestData() {
            // Sort by Lote ID simply numeric
            harvestData.sort((a, b) => {
               const idA = parseInt(a.talhao) || 0;
               const idB = parseInt(b.talhao) || 0;
               return idA - idB;
            });
        }

        // --- FORMULÁRIO ---
        function updateCommercialInput() {
            const variety = document.getElementById('variety').value;
            const wrapper = document.getElementById('commercialVarietyWrapper');
            let html = `<label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Var. Comercial</label>`;
            
            if (variety === 'Pepino') {
                html += `<select id="commercialVariety" required class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-emerald-500 outline-none">
                    <option value="">Selecione...</option>
                    <option value="Aikido">Aikido</option>
                    <option value="Tikara">Tikara</option>
                    <option value="Tsuyataro">Tsuyataro</option>
                    <option value="AGX40404">AGX40404</option>
                    <option value="Japonês">Japonês</option>
                </select>`;
            } else {
                html += `<input type="text" id="commercialVariety" placeholder="Selecione a cultura..." disabled class="w-full p-2 border border-slate-200 bg-slate-50 rounded-lg text-sm text-slate-400 cursor-not-allowed">`;
            }
            
            if(wrapper) wrapper.innerHTML = html;
        }

        // --- FUNÇÕES DE MANIPULAÇÃO DE ITENS E FORMULÁRIO ---
        function addItem(e) {
            e.preventDefault();
            
            const item = {
                talhao: document.getElementById('talhao').value,
                variety: document.getElementById('variety').value,
                commercialVariety: document.getElementById('commercialVariety').value,
                dailyUnits: document.getElementById('dailyUnits').value,
                weight: document.getElementById('weight').value,
                averageWeight: document.getElementById('averageWeight').value,
                cucumberType: document.getElementById('cucumberType').value,
                cucumberSize: document.getElementById('cucumberSize').value,
                harvestNumber: document.getElementById('harvestNumber').value, 
                isDiscard: document.getElementById('isDiscard').checked,
                discardStart: document.getElementById('discardStart').value,
                discardEnd: document.getElementById('discardEnd').value,
                discardDuration: document.getElementById('discardDuration').value
            };

            if (editingIndex >= 0) {
                harvestData[editingIndex] = item;
            } else {
                harvestData.push(item);
            }
            
            sortHarvestData();
            saveData();
            clearBlockForm();
            renderReport();
            renderList();
        }

        function clearBlockForm() {
            ['talhao','dailyUnits','weight','averageWeight','cucumberSize','discardStart','discardEnd','discardDuration'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            
            const varEl = document.getElementById('variety');
            if(varEl) varEl.selectedIndex = 0;

            const typeEl = document.getElementById('cucumberType');
            if(typeEl) typeEl.value = 'Padrão';

            const harvestEl = document.getElementById('harvestNumber');
            if(harvestEl) harvestEl.value = '1'; 

            const discardEl = document.getElementById('isDiscard');
            if(discardEl) {
                discardEl.checked = false;
                toggleDiscardFields(); // Garante que esconde
            }

            updateCommercialInput();
            editingIndex = -1;
            
            const btn = document.getElementById('submitBtn');
            if (btn) {
                btn.innerHTML = '<i data-lucide="plus-circle" class="w-4 h-4"></i> <span>Adicionar ao Relatório</span>';
                btn.classList.replace('bg-blue-600', 'bg-slate-800');
                btn.classList.replace('hover:bg-blue-700', 'hover:bg-slate-900');
            }
            
            const formTitle = document.getElementById('formTitle');
            if(formTitle) formTitle.innerHTML = '<i data-lucide="file-plus" class="text-emerald-600"></i> Adicionar Lote de Produção';
            
            const formContainer = document.getElementById('formContainer');
            if(formContainer) formContainer.classList.remove('border-blue-300', 'ring-2', 'ring-blue-100');
            
            lucide.createIcons();
        }

        function editItem(index) {
            const item = harvestData[index];
            editingIndex = index;
            document.getElementById('talhao').value = item.talhao;
            document.getElementById('variety').value = item.variety;
            updateCommercialInput();
            
            // Timeout para garantir que o input comercial foi recriado
            setTimeout(() => {
                const commEl = document.getElementById('commercialVariety');
                if(commEl) commEl.value = item.commercialVariety;
            }, 0);
            
            ['dailyUnits','weight','averageWeight','cucumberSize'].forEach(k => {
                const el = document.getElementById(k);
                if(el) el.value = item[k] || '';
            });

            const typeEl = document.getElementById('cucumberType');
            if(typeEl) typeEl.value = item.cucumberType || 'Padrão';
            
            const harvestEl = document.getElementById('harvestNumber');
            if(harvestEl) harvestEl.value = item.harvestNumber || '1'; 

            document.getElementById('isDiscard').checked = item.isDiscard || false;
            
            // Preencher campos de descarte e mostrar se necessário
            if(item.isDiscard) {
                document.getElementById('discardStart').value = item.discardStart || '';
                document.getElementById('discardEnd').value = item.discardEnd || '';
                document.getElementById('discardDuration').value = item.discardDuration || '';
            }
            toggleDiscardFields();

            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> <span>Salvar Alterações</span>';
            btn.classList.replace('bg-slate-800', 'bg-blue-600');
            btn.classList.replace('hover:bg-slate-900', 'hover:bg-blue-700');
            document.getElementById('formTitle').innerHTML = '<i data-lucide="pencil" class="text-blue-600"></i> Editando Lote de Produção';
            document.getElementById('formContainer').classList.add('border-blue-300', 'ring-2', 'ring-blue-100');
            document.getElementById('formContainer').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            renderList();
            lucide.createIcons();
        }

        function removeItem(index) {
            if (editingIndex === index) clearBlockForm();
            else if (editingIndex > index) editingIndex--;
            harvestData.splice(index, 1);
            saveData();
            renderReport();
            renderList();
        }

        function clearAll() {
            const btn = document.getElementById('clearAllBtn');
            if (btn.innerText === "Confirmar?") {
                harvestData = [];
                saveData();
                clearBlockForm();
                renderReport();
                renderList();
                btn.innerText = "Limpar Tudo";
                btn.classList.remove("text-red-700", "underline");
                btn.classList.add("text-red-500");
                clearTimeout(clearConfirmTimer);
            } else {
                btn.innerText = "Confirmar?";
                btn.classList.remove("text-red-500");
                btn.classList.add("text-red-700", "underline");
                clearConfirmTimer = setTimeout(() => {
                    btn.innerText = "Limpar Tudo";
                    btn.classList.remove("text-red-700", "underline");
                    btn.classList.add("text-red-500");
                }, 3000);
            }
        }

        // --- FUNÇÕES NOVAS PARA DESCARTE ---
        function toggleDiscardFields() {
            const isChecked = document.getElementById('isDiscard').checked;
            const container = document.getElementById('discardFields');
            if(isChecked) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function calcDiscardDuration() {
            const start = document.getElementById('discardStart').value;
            const end = document.getElementById('discardEnd').value;
            const durationEl = document.getElementById('discardDuration');

            if (start && end) {
                const [startH, startM] = start.split(':').map(Number);
                const [endH, endM] = end.split(':').map(Number);

                // Data base arbitrária para cálculo
                let startDate = new Date(2000, 0, 1, startH, startM);
                let endDate = new Date(2000, 0, 1, endH, endM);

                // Se fim for menor que inicio, assume que virou o dia (pouco provável em colheita, mas ok)
                if (endDate < startDate) {
                    endDate.setDate(endDate.getDate() + 1);
                }

                let diffMs = endDate - startDate;
                const hours = Math.floor(diffMs / 1000 / 60 / 60);
                const minutes = Math.floor((diffMs / 1000 / 60) % 60);

                durationEl.value = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')} h`;
            } else {
                durationEl.value = '';
            }
        }

        function renderList() {
            const list = document.getElementById('itemsList');
            list.innerHTML = harvestData.length ? '' : '<li class="text-center text-slate-400 italic py-2">Nenhum bloco adicionado.</li>';
            harvestData.forEach((item, index) => {
                const active = index === editingIndex ? 'border-blue-400 bg-blue-50 ring-1' : 'border-slate-100 bg-slate-50';
                list.innerHTML += `
                    <li class="flex justify-between items-center p-2 rounded border ${active} transition-all">
                        <span><b>#${item.talhao}</b> - ${item.variety} ${index === editingIndex ? '<span class="text-[10px] text-blue-600 font-bold ml-2">(Editando)</span>' : ''}</span>
                        <div class="flex items-center">
                            <button onclick="editItem(${index})" class="text-blue-500 hover:bg-blue-100 p-1.5 rounded-md mr-1"><i data-lucide="pencil" width="14"></i></button>
                            <button onclick="removeItem(${index})" class="text-red-500 hover:bg-red-100 p-1.5 rounded-md"><i data-lucide="trash-2" width="14"></i></button>
                        </div>
                    </li>`;
            });
            lucide.createIcons();
        }

        function renderReport() {
            // ATUALIZAR TÍTULO BASEADO NOS DADOS
            updateDynamicTitle();

            const container = document.getElementById('reportContent');
            const summaryStats = document.getElementById('summaryStats');
            let sumDailyUnits = 0, sumWeight = 0;

            if (!harvestData.length) {
                container.innerHTML = `<div class="p-8 text-center text-slate-400 text-xs italic leading-relaxed h-full flex items-center justify-center">Adicione blocos no formulário ao lado.</div>`;
            } else {
                container.innerHTML = '';
                harvestData.forEach(item => {
                    // Removed progress bar logic (progressColor, textColor)
                    sumDailyUnits += parsePTBRNumber(item.dailyUnits);
                    sumWeight += parsePTBRNumber(item.weight);

                    // Lógica para destacar a cor baseada no tipo
                    let typeHighlight = false;
                    if (item.cucumberType === 'Curvado') typeHighlight = 'orange';
                    else if (item.cucumberType === 'Padrão') typeHighlight = 'green';

                    // Create Type Block with dynamic color
                    const typeHtml = createStatItem('tag', item.cucumberType || '-', 'TIPO', typeHighlight);
                    
                    // Etiqueta de Descarte
                    const discardLabel = item.isDiscard 
                        ? `<div class="flex flex-col items-center justify-center gap-1 text-red-600 bg-red-50 border border-red-100 px-2 py-1.5 rounded-lg shadow-sm">
                             <span class="text-[10px] font-black uppercase tracking-widest leading-none">DESCARTE</span>
                             <i data-lucide="trash-2" width="14"></i>
                           </div>` 
                        : '';

                    const harvestCount = item.harvestNumber || '1';
                    const harvestText = harvestCount === '1' ? '1 Colheita' : `${harvestCount} Colheitas`;
                    
                    // FORMATAÇÃO INTELIGENTE APLICADA AOS ITENS INDIVIDUAIS
                    // Recalcula média caso venha do storage antigo ou formata o existente
                    const rawWeight = parsePTBRNumber(item.weight);
                    const rawUnits = parsePTBRNumber(item.dailyUnits);
                    const calculatedAvg = rawUnits > 0 ? (rawWeight / rawUnits) : 0;
                    
                    const displayWeight = formatSmart(rawWeight);
                    const displayAvg = formatSmart(calculatedAvg);

                    // HTML dos detalhes de descarte
                    let discardDetailsHtml = '';
                    if (item.isDiscard && (item.discardStart || item.discardEnd)) {
                        discardDetailsHtml = `
                        <div class="mt-3 pt-3 border-t border-red-100 flex items-center justify-between gap-2 text-[10px] text-red-700 bg-red-50 p-2 rounded-lg">
                             <div class="flex items-center gap-1 px-2 py-1">
                                <span class="font-bold text-emerald-600">Início:</span> 
                                <span class="font-bold text-slate-700">${item.discardStart || '--:--'}</span>
                             </div>
                             <div class="flex items-center gap-1 px-2 py-1">
                                <span class="font-bold text-red-600">Fim:</span> 
                                <span class="font-bold text-slate-700">${item.discardEnd || '--:--'}</span>
                             </div>
                             <div class="flex items-center gap-1 px-2 py-1">
                                <span class="font-bold text-red-800">Total:</span> 
                                <span class="font-black text-slate-800">${item.discardDuration || '00:00 h'}</span>
                             </div>
                        </div>`;
                    }

                    container.innerHTML += `
                    <div class="p-5 hover:bg-slate-50 transition-colors group">
                        
                        <div class="flex justify-between items-start mb-4 border-b border-slate-100 pb-2">
                            <div class="flex flex-col items-start">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xl font-black text-slate-800 uppercase tracking-tight leading-none">${item.commercialVariety ? `${item.variety} - ${item.commercialVariety}` : item.variety}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">SETOR ${item.talhao}</span>
                                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">-</span>
                                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">${harvestText}</span>
                                </div>
                            </div>
                            ${discardLabel}
                        </div>

                        <div class="flex flex-col gap-3"> 
                            
                            <!-- DADOS PRINCIPAIS -->
                            <div class="grid grid-cols-2 gap-2">
                                ${createStatItem('package', item.dailyUnits, 'UNIDADES (HOJE)', true)}
                                ${createStatItem('scale', displayWeight, 'PESO (KG)')}
                                ${createStatItem('gauge', displayAvg + ' g', 'PESO MÉDIO (G/UNID.)')}
                                ${createStatItem('ruler', item.cucumberSize || '-', 'TAM. MÉDIO (CM)')}
                            </div>
                            
                            <!-- DETALHES DE DESCARTE -->
                            ${discardDetailsHtml}
                        </div>
                    </div>`;
                });
            }

            
            // Cálculo do Peso Médio Geral
            const overallAvg = sumDailyUnits > 0 ? (sumWeight / sumDailyUnits) : 0;
            
            // FORMATAÇÃO INTELIGENTE PARA TOTAIS
            const totalWeightFormatted = formatSmart(sumWeight);
            const overallAvgFormatted = formatSmart(overallAvg);

            summaryStats.innerHTML = `
                <div class="bg-orange-50 rounded-lg p-4 flex justify-around items-center border border-orange-100 shadow-sm">
                    <div class="text-center">
                        <div class="text-[10px] text-orange-600 font-bold uppercase mb-1">TOTAL DE UNIDADES</div>
                        <div class="text-xl font-extrabold text-orange-800">${sumDailyUnits.toLocaleString('pt-BR')}</div>
                    </div>
                    <div class="w-px h-10 bg-orange-200"></div>
                    <div class="text-center">
                        <div class="text-[10px] text-orange-600 font-bold uppercase mb-1">TOTAL PESO (KG)</div>
                        <div class="text-xl font-extrabold text-orange-800">${totalWeightFormatted}</div>
                    </div>
                    <div class="w-px h-10 bg-orange-200"></div>
                    <div class="text-center">
                        <div class="text-[10px] text-orange-600 font-bold uppercase mb-1">MÉDIA GERAL (G/UNID.)</div>
                        <div class="text-xl font-extrabold text-orange-800">${overallAvgFormatted + ' g'}</div>
                    </div>
                </div>`;
            lucide.createIcons();
        }

        function createStatItem(iconName, value, label, highlight = false) {
            let bgClass = 'bg-slate-50';
            let iconClass = 'text-slate-400';
            let valueClass = 'text-slate-700';
            let labelClass = 'text-slate-400';

            if (highlight === 'orange') {
                bgClass = 'bg-orange-50';
                iconClass = 'text-orange-600';
                valueClass = 'text-orange-800';
                labelClass = 'text-orange-600';
            } else if (highlight === 'red') {
                bgClass = 'bg-red-50';
                iconClass = 'text-red-600';
                valueClass = 'text-red-800';
                labelClass = 'text-red-600';
            } else if (highlight === true || highlight === 'green') {
                bgClass = 'bg-emerald-50';
                iconClass = 'text-emerald-600';
                valueClass = 'text-emerald-800';
                labelClass = 'text-emerald-600';
            }

            return `
            <div class="flex flex-col items-center justify-center p-3 rounded-xl ${bgClass}">
                <div class="mb-1 ${iconClass} icon-fix"><i data-lucide="${iconName}" width="14"></i></div>
                <span class="text-xs font-bold ${valueClass}">${value}</span>
                <span class="text-[9px] uppercase tracking-wider font-semibold ${labelClass} mt-1 text-center leading-tight">${label}</span>
            </div>`;
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('report-card');
            const originalText = document.querySelector('button[onclick="downloadPDF()"] span').innerText;
            document.querySelector('button[onclick="downloadPDF()"] span').innerText = "Gerando PDF...";
            
            try {
                const options = {
                    scale: 3, 
                    useCORS: true,
                    allowTaint: true,
                    scrollY: -window.scrollY,
                    backgroundColor: '#ffffff', 
                    onclone: (doc) => {
                        const el = doc.getElementById('report-card');
                        const content = doc.getElementById('reportContent');
                        
                        if (el) { 
                            el.style.width = '450px'; 
                            el.style.maxWidth = '450px';
                            el.style.margin = '0'; 
                            el.style.boxShadow = 'none';
                            el.style.borderRadius = '0';
                            el.style.border = 'none';
                        }
                        if (content) { 
                            content.style.height = 'auto'; 
                            content.style.overflow = 'visible'; 
                            content.style.maxHeight = 'none';
                        }
                    }
                };

                const canvas = await html2canvas(element, options);
                
                const imgWidth = 450; 
                const pageHeight = (canvas.height * imgWidth) / canvas.width; 

                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'px',
                    format: [imgWidth, pageHeight], 
                    hotfixes: ['px_scaling']
                });

                const imgData = canvas.toDataURL('image/png'); 
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, pageHeight);
                
                const now = new Date();
                const daysOfWeek = ["Domingo", "Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];
                const dayOfWeek = daysOfWeek[now.getDay()];
                
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const weekNumber = getWeekNumber(now); 

                const hasDiscard = harvestData.length > 0 && harvestData.some(item => item.isDiscard);
                const prefix = hasDiscard ? "Descarte" : "Resumo Colheita";

                const filename = `${prefix} - ${dayOfWeek} ${day}-${month}-${year} Semana ${weekNumber} - SPG SEDE.pdf`;
                pdf.save(filename);

            } catch (err) { 
                console.error("Erro ao gerar PDF:", err);
            } 
            finally { 
                document.querySelector('button[onclick="downloadPDF()"] span').innerText = originalText; 
            }
        }

        async function downloadImage() {
            const element = document.getElementById('report-card');
            const btnSpan = document.querySelector('button[onclick="downloadImage()"] span');
            const originalText = btnSpan.innerText;
            btnSpan.innerText = "Gerando...";

            try {
                if (harvestData.length === 0) {
                    showMessageModal('Atenção', 'Adicione registros primeiro.', 'error');
                    return;
                }

                const options = {
                    scale: 5, 
                    useCORS: true, 
                    allowTaint: true,
                    scrollY: -window.scrollY,
                    backgroundColor: '#ffffff', 
                    onclone: (doc) => {
                        const el = doc.getElementById('report-card');
                        const content = doc.getElementById('reportContent');
                        
                        if (el) { 
                            el.style.width = '450px'; 
                            el.style.maxWidth = '450px';
                            el.style.margin = '0'; 
                            el.style.boxShadow = 'none';
                            el.style.borderRadius = '0';
                            el.style.border = 'none';
                        }
                        if (content) { 
                            content.style.height = 'auto'; 
                            content.style.overflow = 'visible'; 
                            content.style.maxHeight = 'none';
                        }
                    }
                };

                const canvas = await html2canvas(element, options);
                
                // Lógica de nome do arquivo
                const now = new Date();
                const dateStr = now.toLocaleDateString('pt-BR').replace(/\//g, '-');
                const weekNum = getWeekNumber(now);
                let weekday = now.toLocaleDateString('pt-BR', { weekday: 'long' });
                weekday = weekday.charAt(0).toUpperCase() + weekday.slice(1);

                const hasDiscard = harvestData.length > 0 && harvestData.some(item => item.isDiscard);
                const prefix = hasDiscard ? "Descarte" : "Resumo Colheita";
                const partnerName = "SPG SEDE";

                const filename = `${prefix} - ${weekday} ${dateStr} Semana ${weekNum} - ${partnerName}.png`;

                // Tenta compartilhar nativamente (Mobile)
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], filename, { type: 'image/png' });

                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({
                                files: [file],
                                title: filename,
                                text: 'Segue o resumo da colheita.'
                            });
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                console.error('Erro ao compartilhar:', err);
                                // Fallback se falhar
                                downloadFile(canvas.toDataURL('image/png'), filename);
                            }
                        }
                    } else {
                        // Fallback Desktop
                        downloadFile(canvas.toDataURL('image/png'), filename);
                        
                        // Abre WhatsApp Web como fallback visual
                        showMessageModal('Imagem Salva', 'A imagem foi baixada. Abrindo WhatsApp...', 'success');
                        setTimeout(() => {
                             window.open('https://web.whatsapp.com/', '_blank');
                        }, 2000);
                    }
                }, 'image/png');

            } catch (err) { 
                console.error("Erro ao gerar Imagem:", err);
                showMessageModal('Erro', 'Falha ao gerar imagem: ' + err.message, 'error');
            } 
            finally { 
                btnSpan.innerText = originalText; 
            }
        }

        function downloadFile(uri, name) {
            const link = document.createElement('a');
            link.href = uri;
            link.download = name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- FUNÇÕES DE MENSAGEM MODAL ---
        function showMessageModal(title, message, type) {
            const modal = document.getElementById('messageModal');
            const iconContainer = document.getElementById('msgIconContainer');
            const titleEl = document.getElementById('msgTitle');
            const textEl = document.getElementById('msgText');

            titleEl.innerText = title;
            textEl.innerText = message;

            if (type === 'error') {
                iconContainer.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4";
                iconContainer.innerHTML = '<i data-lucide="alert-circle" class="h-6 w-6 text-red-600"></i>';
            } else if (type === 'success') {
                iconContainer.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4";
                iconContainer.innerHTML = '<i data-lucide="check-circle" class="h-6 w-6 text-green-600"></i>';
            } else {
                iconContainer.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4";
                iconContainer.innerHTML = '<i data-lucide="info" class="h-6 w-6 text-blue-600"></i>';
            }

            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function hideMessageModal() {
            document.getElementById('messageModal').classList.add('hidden');
        }
    </script>
</body>
</html>
